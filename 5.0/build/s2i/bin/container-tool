#!/usr/bin/sh

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
BUILD_DIR="/tmp/container-tool"

# command that builds the tool, used by the image build.
if [ "$1" == "build-tool" ]; then
  set -x

  mkdir $BUILD_DIR
  export TMPDIR=${BUILD_DIR}
  pushd $BUILD_DIR

  # cs file
  cp "$SCRIPT_DIR/ContainerTool.cs" .
  # csproj
  cat <<EOF >container-tool.csproj
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>${DOTNET_FRAMEWORK}</TargetFramework>
  </PropertyGroup>

</Project>
EOF
  # nuget.config
  cat <<EOF >nuget.config
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <packageSources>
    <clear />
  </packageSources>
</configuration>
EOF

  dotnet publish -c Release -o published
  cp published/* "$SCRIPT_DIR"

  popd

  set +e
  # /tmp/.dotnet/shm is created even with the TMPDIR change,
  # so make sure to remove that as well.
  rm -rf $BUILD_DIR /tmp/.dotnet

  exit 0
fi

exec dotnet "$SCRIPT_DIR/container-tool.dll" "$@"
