#!/bin/bash

set -e

# User settable environment
DOTNET_CONFIGURATION="${DOTNET_CONFIGURATION:-Release}"
DOTNET_STARTUP_PROJECT="${DOTNET_STARTUP_PROJECT:-.}"
DOTNET_RESTORE_ROOT="${DOTNET_RESTORE_ROOT:-.}"

# Private environment
DOTNET_FRAMEWORK="netcoreapp1.1"

# npm
if [ -n "${DOTNET_NPM_TOOLS}" ]; then
  echo "---> Installing npm tools ..."
  pushd $HOME
  npm install ${DOTNET_NPM_TOOLS}
  popd
fi

echo "---> Copying application source ..."
cp -Rf /tmp/src/. ./

echo "---> Installing dependencies ..."
dotnet restore $DOTNET_RESTORE_ROOT

echo "---> Building application from source ..."
dotnet publish -f "$DOTNET_FRAMEWORK" -c "$DOTNET_CONFIGURATION" "$DOTNET_STARTUP_PROJECT" -o "$DOTNET_PUBLISH_PATH"

for TEST_PROJECT in $DOTNET_TEST_PROJECTS; do
    echo "---> Running test project: $TEST_PROJECT..."
    dotnet test "$TEST_PROJECT" -f "$DOTNET_FRAMEWORK"
done

# Create run script in publish folder
APP_DLL_NAME="$(basename "$(realpath "${DOTNET_STARTUP_PROJECT}")").dll"
cat << EOF >"$DOTNET_RUN_SCRIPT"
#!/bin/bash
exec dotnet ${APP_DLL_NAME} \$@
EOF
chmod +x "$DOTNET_RUN_SCRIPT"

# Fix source directory permissions
fix-permissions ./
# set permissions for any installed artifacts
fix-permissions /opt/app-root
